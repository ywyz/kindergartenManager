# 🤖 AI集成完整指南

本文档全面介绍系统的AI功能、集成方案和自定义方法。为即将进行的AI接入工作提供参考。

---

## 📖 目录

1. [概述](#概述)
2. [核心功能](#核心功能)
3. [集成架构](#集成架构)
4. [配置方案](#配置方案)
5. [自定义指南](#自定义指南)
6. [案例集合](#案例集合)
7. [故障排查](#故障排查)

---

## 概述

### 什么是AI拆分功能？

系统使用OpenAI的大语言模型（LLM）自动将教师输入的完整教案原稿拆分为结构化的多个字段：

**输入**：
```
小班数学活动《认识圆形》。通过直观的教具和PPT展示，帮助幼儿认识圆形的基本特征。
活动准备包括圆形教具、PPT课件和相关操作材料。
目标是让幼儿理解圆形，能够与其他形状区分...
```

**输出**（AI自动生成）：
```json
{
  "活动主题": "小班数学活动《认识圆形》",
  "活动目标": "1. 认识圆形，感知其基本特征\n2. 能够将圆形与其他形状区分",
  "活动准备": "圆形教具、PPT课件、操作材料",
  "活动重点": "理解圆形的基本特征",
  "活动难点": "圆形与其他形状的区分",
  "活动过程": "1. 导入环节\n2. 探索环节\n3. 拓展环节"
}
```

---

## 核心功能

### 1. 集体活动智能拆分

**使用场景**：教师有完整的活动原稿，需要拆分为6个标准字段

**操作步骤**：
1. 在"集体活动管理原稿"输入框输入完整的活动描述
2. 点击"分割集体活动"按钮
3. 系统调用AI模型进行处理
4. 自动填充以下6个字段：
   - 活动主题
   - 活动目标
   - 活动准备
   - 活动重点
   - 活动难点
   - 活动过程

**API接口**（开发者）：
```python
import kg_manager as kg

result = kg.split_collective_activity(
    draft_text="完整的活动原稿...",
    api_key="sk-...",  # 可选，不传则读环境变量
    model="gpt-4o-mini",  # 可选
    base_url="https://api.openai.com/v1"  # 可选
)
# result = {
#     "活动主题": "...",
#     "活动目标": "...",
#     ...
# }
```

### 2. 自定义AI行为

**高级用法** - 指定自定义的提示词：

```python
import kg_manager as kg

# 设置自定义提示词（全局）
kg.set_custom_system_prompt("""
你是幼儿园教案设计专家。你需要将用户提供的教案原稿拆分为以下6个结构化字段...
[自定义要求]
""")

# 之后调用的split_collective_activity都会使用该提示词
result = kg.split_collective_activity(draft_text)
```

---

## 集成架构

### 系统中的AI集成点

```
┌──────────────────────────────┐
│    用户在表单中输入原稿        │
└────────────┬─────────────────┘
             │
             ▼
┌──────────────────────────────┐
│   点击"分割集体活动"按钮       │
└────────────┬─────────────────┘
             │
             ▼
┌──────────────────────────────┐
│   app.py调用AI处理函数       │
│  kg.split_collective_activity() │
└────────────┬─────────────────┘
             │
             ▼
┌──────────────────────────────┐
│    kg_manager/ai.py          │
│  - 构建请求                   │
│  - 调用OpenAI API            │
│  - 解析响应                   │
└────────────┬─────────────────┘
             │
             ▼
┌──────────────────────────────┐
│   OpenAI API (GPT Model)     │
└────────────┬─────────────────┘
             │
             ▼
┌──────────────────────────────┐
│    返回结构化数据             │
│  (JSON格式)                   │
└────────────┬─────────────────┘
             │
             ▼
┌──────────────────────────────┐
│   自动填充表单字段            │
│   (6个子字段)                 │
└──────────────────────────────┘
```

### 数据流

```
app.py (NiceGUI UI层)
   │
   ├─ 收集用户输入：draft_text
   │
   ├─ 从localStorage读取配置：
   │  ├─ AI API Key
   │  ├─ AI Model
   │  └─ Base URL
   │
   └─▶ kg.split_collective_activity()
       │
       └─▶ kg_manager/ai.py
           │
           ├─ 构建请求体 (system_prompt + user_input)
           │
           ├─ 调用 OpenAI API
           │
           ├─ 解析 JSON 响应
           │
           └─▶ 返回解析结果
               │
               回到 app.py
               │
               ├─ 验证结构
               │
               └─ 自动填充表单的6个字段
```

---

## 配置方案

### 方案A：官方 OpenAI API

**优点**：
- ✅ 官方支持，最稳定
- ✅ 模型最新，功能最全
- ✅ 速度快，质量好

**成本**：根据请求token数计费

**配置**：
1. 访问 [OpenAI API Keys](https://platform.openai.com/api/keys)
2. 创建API Key
3. 在系统中配置该Key
4. 自动使用官方API端点

### 方案B：第三方兼容API

对于无法直接访问OpenAI的地区，可以使用兼容的第三方服务：

**ChatAnywhere**：
```
API地址: https://api.chatanywhere.com.cn/v1
优点: 支持各种主流LLM, 价格低
```

**OpenAI-SB**：
```
API地址: https://api.openai-sb.com/v1
优点: 国内加速，延迟低
```

**配置步骤**：
1. 注册获得API Key
2. 在系统配置中：
   - API Key：输入第三方Key
   - AI模型：输入对应的模型名（如 `gpt-4o-mini`）
   - API地址：输入 `https://api.chatanywhere.com.cn/v1`
3. 点击保存

### 方案C：本地/自建 LLM

对于需要离线部署或成本控制的场景，可以集成本地模型。

**支持的选项**：
- Ollama（本地运行）
- LLaMA（Meta开源模型）
- Qwen（阿里通义模型）
- 等其他兼容 OpenAI 格式的 API

**配置步骤**：
1. 启动本地LLM服务，通常监听在 `http://localhost:8000` 或 `http://localhost:5000`
2. 在系统配置中：
   - API Key：输入 `local` 或任意值（本地模型通常不需要）
   - AI模型：输入本地模型名（如 `llama2`）
   - API地址：输入 `http://localhost:8000/v1` 或对应地址
3. 点击保存

---

## 自定义指南

### 1. 修改AI提示词

查看当前代码中的默认提示词：
```python
# kg_manager/ai.py 中的 DEFAULT_SYSTEM_PROMPT
```

**全局修改**（开发者）：
```python
# 在 app.py 或其他需要的地方
import kg_manager as kg

# 设置全局提示词
kg.set_custom_system_prompt("""
你是资深幼儿园教案设计专家，拥有15年教学经验。
你需要将以下原文稿拆分为6个部分...
[详细说明]
""")
```

### 2. 调整拆分粒度

默认AI拆分为6个字段。如需其他粒度，可修改提示词：

**更细致的拆分**（8个字段）：
```python
kg.set_custom_system_prompt("""
将活动原稿拆分为以下8个部分：
1. 活动主题
2. 活动年龄段
3. 活动目标
4. 活动准备
5. 活动重点
6. 活动难点
7. 活动过程（包含活动时间）
8. 活动延伸与评价
[JSON格式要求...]
""")
```

### 3. 优化输出质量

通过调整提示词改进AI输出：

```python
# 强调格式规范
kg.set_custom_system_prompt("""
要求：
- 每个字段内容控制在100-200字
- 使用数字序号列表
- 避免专业术语，用简洁语言
- 强调可操作性和幼儿友好性
[完整提示词...]
""")

# 强调内容丰富性
kg.set_custom_system_prompt("""
要求：
- 每个字段详细展开，内容丰富
- 包含具体的操作步骤
- 列举多个教学策略
- 提供教具使用建议
[完整提示词...]
""")
```

### 4. 支持不同教学方法

```python
# 蒙台梭利教学法
kg.set_custom_system_prompt("""
基于蒙台梭利教学法拆分教案...
强调：
- 儿童主导的学习
- 自我修正的教具
- 整体课程观
""")

# 游戏化学习
kg.set_custom_system_prompt("""
基于游戏化学习拆分教案...
强调：
- 趣味性和参与度
- 游戏规则清晰
- 学习隐性进行
""")
```

---

## 案例集合

### 案例1：处理模糊原稿

**输入**：
```
小班主题《春天来了》，主要是让孩子认识春天的变化，看花看草，体验季节变化。
用卡片和真实花朵作教具，做一些手工活动。
```

**自定义提示词**：
```python
kg.set_custom_system_prompt("""
这是一个比较宽泛的主题原稿，请进行丰富和具体化：
- 明确设定年龄段（小班：3-4岁）
- 补充具体的学习目标（知识、技能、情感）
- 详细描述教具和材料
- 规划完整的活动流程（导入-探索-表现-总结）
- 列举可能的困难点
[完整格式要求...]
""")
```

### 案例2：处理多个活动的混合原稿

**输入**：
```
上午进行手指操表演和绘画活动，下午进行户外游戏和音乐欣赏...
```

**处理方法**：
```python
# 分开处理不同的活动
activities = [
    "上午手指操表演活动...",
    "上午绘画活动...",
    "下午户外游戏...",
    "下午音乐欣赏..."
]

for activity in activities:
    result = kg.split_collective_activity(activity)
    # 一个一个处理
```

### 案例3：优化输出格式

**问题**：AI输出格式不统一，有时分段，有时一整段

**解决**：
```python
kg.set_custom_system_prompt("""
格式要求（必须严格遵守）：
- 活动目标：使用"1. ... 2. ... 3. ..." 的编号格式，每项一行
- 活动准备：使用"- 项目1\n- 项目2" 的无序列表
- 活动过程：使用"第一环节：...时间...\\n第二环节：...时间..."的明确分段
- 输出必须是有效的JSON格式
[示例JSON...]
""")
```

---

## 故障排查

### 问题1：AI返回格式错误

**症状**：提示"AI 返回格式不正确"

**原因**：AI的输出不是有效的JSON

**解决方案**：
1. 检查prompt中的JSON格式要求是否明确
2. 尝试更简单的提示词
3. 换用其他AI模型测试
4. 查看浏览器控制台获取详细的错误信息

### 问题2：API调用超时

**症状**：长时间无响应，最后提示"超时"

**原因**：
- 网络连接慢
- API服务响应慢
- 原稿过长导致token数过多

**解决方案**：
1. 检查网络连接
2. 尝试缩短输入的原稿
3. 更换更快的模型（如 `gpt-3.5-turbo`）
4. 确认API服务是否正常：`curl https://api.openai.com/v1/models`

### 问题3：API Key无效

**症状**：提示"401 Unauthorized"

**原因**：
- Key已过期或被删除
- Key输入错误
- Key没有有效的额度

**解决方案**：
1. 访问 [OpenAI API Keys](https://platform.openai.com/api/keys) 确认Key有效
2. 检查 [Billing](https://platform.openai.com/billing/overview) 确认有余额
3. 重新复制并粘贴Key
4. 尝试创建新的Key

### 问题4：输出质量不理想

**症状**：AI拆分的结果不符合预期

**解决方案**：
1. **调整提示词** - 给出更详细的要求
2. **改进输入** - 提供更清晰、更结构化的原稿
3. **更换模型** - `gpt-4o` 的质量通常优于 `gpt-4o-mini`
4. **提供示例** - 在提示词中给出期望的输出示例

---

## 💡 最佳实践

1. **明确的提示词** - 提供具体的要求和约束条件
2. **逐步改进** - 先用基础配置，再根据效果优化
3. **成本控制** - 用 `gpt-4o-mini` 处理常规任务，用 `gpt-4o` 处理复杂任务
4. **错误处理** - 总是有备选方案，万一AI失败能人工补救
5. **定期验证** - 定期检查AI输出质量，及时调整

---

## 🔗 相关文档

→ [系统配置指南](user-guide/config-guide.md) - 如何配置API Key

→ [用户使用指南](user-guide.md) - 如何在UI中使用AI功能

→ [提示词自定义](prompt-customization.md) - 更多提示词示例

→ [故障排查](troubleshooting.md) - 常见问题解决

→ [支持的模型](supported-models.md) - 所有支持的AI模型列表
